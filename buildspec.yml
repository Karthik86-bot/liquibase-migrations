version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto17

    commands:
      - echo "Installing Liquibase"

      - rm -rf /opt/liquibase /tmp/liquibase liquibase.tar.gz

      - mkdir -p /tmp/liquibase
      - cd /tmp/liquibase

      - curl -L https://github.com/liquibase/liquibase/releases/download/v4.25.1/liquibase-4.25.1.tar.gz -o liquibase.tar.gz

      - tar -xzf liquibase.tar.gz

      - echo "Files after extract:"
      - ls -l

      - mkdir -p /opt/liquibase
      - cp -r ./* /opt/liquibase/

      - chmod +x /opt/liquibase/liquibase

      - ln -sf /opt/liquibase/liquibase /usr/local/bin/liquibase

      - cd $CODEBUILD_SRC_DIR

      - yum install -y jq

      - liquibase --version

  pre_build:
    commands:
      - echo "Fetching DB credentials"

      - SECRET=$(aws secretsmanager get-secret-value --region eu-north-1 --secret-id prod/appbeta/rds/mysql --query SecretString --output text)

      - export DB_USER=$(echo "$SECRET" | jq -r .username)
      - export DB_PASS=$(echo "$SECRET" | jq -r .password)
      - export DB_HOST=$(echo "$SECRET" | jq -r .host)
      - export DB_PORT=$(echo "$SECRET" | jq -r .port)

      - echo "DB Host is $DB_HOST"
      - echo "DB Port is $DB_PORT"

  build:
    commands:
      - echo "Running Liquibase"

      - ls -R liquibase/changelog

      - liquibase --url="jdbc:postgresql://$DB_HOST:$DB_PORT/postgres" --username="$DB_USER" --password="$DB_PASS" --changeLogFile=liquibase/changelog/master.xml update
